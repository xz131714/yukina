---
// 直接从配置模块导入评论配置
import commentConfig from "../../config/comment";

const giscusConfig = commentConfig.giscus;
---

{giscusConfig?.enable && (
  <div class="giscus-container">
    <!-- Giscus 将在此处加载 -->
  </div>

  <script define:vars={{ giscusConfig }} is:inline>
    function getCurrentTheme() {
      // 检查主题类
      return document.documentElement.classList.contains('dark') ? 'dark' : 'light';
    }
      
    function loadGiscus() {
      const container = document.querySelector('.giscus-container');
      if (!container) return;
      
      // 清空容器，防止重复加载
      container.innerHTML = '<!-- Giscus 将在此处加载 -->';
      
      // 获取当前主题
      const theme = getCurrentTheme();
        
      const script = document.createElement('script');
      script.src = 'https://giscus.app/client.js';
      script.setAttribute('data-repo', giscusConfig.repo);
      script.setAttribute('data-repo-id', giscusConfig.repoId);
      script.setAttribute('data-category', giscusConfig.category);
      script.setAttribute('data-category-id', giscusConfig.categoryId);
      script.setAttribute('data-mapping', giscusConfig.mapping || 'pathname');
      script.setAttribute('data-strict', giscusConfig.strict || '0');
      script.setAttribute('data-reactions-enabled', giscusConfig.reactionsEnabled || '1');
      script.setAttribute('data-emit-metadata', giscusConfig.emitMetadata || '0');
      script.setAttribute('data-input-position', giscusConfig.inputPosition || 'top');
      script.setAttribute('data-theme', theme);
      script.setAttribute('data-lang', giscusConfig.lang || 'zh-CN');
      script.setAttribute('data-loading', giscusConfig.loading || 'lazy');
      script.setAttribute('crossorigin', 'anonymous');
      script.async = true;
      
      container.appendChild(script);
    }  
      
    function updateGiscusTheme() {
      const theme = getCurrentTheme();
      const iframe = document.querySelector('iframe.giscus-frame');
      
      if (iframe) {
        iframe.contentWindow.postMessage({
          giscus: { setConfig: { theme } }
        }, 'https://giscus.app');
      }
    }
    
    // 初始加载
    loadGiscus();
    
    // 监听主题变化
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
          setTimeout(updateGiscusTheme, 200);
        }
      });
    });
    
    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['class']
    });
    
    // 页面切换时重新加载
    document.addEventListener('astro:page-load', () => {
      // 使用setTimeout确保DOM完全加载
      setTimeout(loadGiscus, 300);
    });
    
    // 兼容旧版事件
    document.addEventListener('astro:after-swap', () => {
      setTimeout(loadGiscus, 300);
    });
  </script>
  
  <style>
    .giscus-container {
      margin-top: 2rem;
    }
  </style>
)}